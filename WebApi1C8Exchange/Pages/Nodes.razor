@page "/nodes"
@attribute [Authorize(Roles ="Admin")]

@using WebApiDocumentsExchange.Models
@using WebApiDocumentsExchange.Data
@using Microsoft.EntityFrameworkCore

@inject ExchangeDbContext dbContext
@inject DialogService DialogService

<RadzenButton Icon="add_circle_outline"
              style="margin-bottom: 10px"
              Text="Створити нод"
              Click="@InsertRow"
              Disabled=@(itemToInsert != null) />

<RadzenButton Icon="delete"
              style="margin-bottom: 10px;margin-left:20px"
              ButtonStyle="ButtonStyle.Danger"
              Text="Видалити"
              Click="@(args => DeleteRow(selectedItems !=null?selectedItems[0]:null))"
              Disabled=@((selectedItems?.Count ?? 0) == 0) />


<RadzenDataGrid Data="@items" @ref="grid"
                TItem="ClientNode"
                AllowFiltering="true"
                AllowColumnResize="true"
                AllowPaging="true"
                PageSize="10"
                AllowSorting="true"
                EditMode="DataGridEditMode.Single"
                @bind-Value=@selectedItems
                RowUpdate="@OnUpdateRow"
                RowCreate="@OnCreateRow">
    <Columns>
         <RadzenDataGridColumn Frozen="true" TItem="ClientNode" Context="sampleBlazorModelsSampleOrder" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="100px">
            <Template Context="client">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Class="m-1" Click="@(args => EditRow(client))" @onclick:stopPropagation="true" />
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger"  Size="ButtonSize.Small" Class="m-1" Click="@(args => DeleteRow(client))"  @onclick:stopPropagation="true"/>
            </Template>
            <EditTemplate Context="client">
                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Primary"  Click="@((args) => SaveRow(client))" />
                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light"  Click="@((args) => CancelEdit(client))" />
            </EditTemplate>
        </RadzenDataGridColumn>

         <RadzenDataGridColumn TItem="ClientNode" Property="Name" Title="Name" Width="100px">
            <EditTemplate Context="node">
                <RadzenTextBox @bind-Value="node.Name"  Disabled="node.Name!=null" TValue="string" Width="100%" />
            </EditTemplate>
         </RadzenDataGridColumn>
         
         <RadzenDataGridColumn TItem="ClientNode"  Property="Description" Title="Description" Width="100px">
            <EditTemplate Context="node">
                <RadzenTextBox @bind-Value="node.Description" TValue="string" Width="100%" />
            </EditTemplate>
         </RadzenDataGridColumn>
        
         <RadzenDataGridColumn TItem="ClientNode"  Property="Password" Title="Password" Width="100px">
            <EditTemplate Context="node">
                <RadzenTextBox @bind-Value="node.Password" TValue="string" Width="100%" />
            </EditTemplate>
         </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private IEnumerable<ClientNode>? items;
    private RadzenDataGrid<ClientNode>? grid;

    ClientNode? itemToInsert;
    IList<ClientNode>? selectedItems;

    void resetItemToIntert(ClientNode item)
    {
        if (item == itemToInsert)
        {
            itemToInsert = null;
        }
    }

    void OnUpdateRow(ClientNode item)
    {
        resetItemToIntert(item);
        dbContext.Update(item);
        dbContext.SaveChanges();
    }


    protected override void OnInitialized()
    {
        items = dbContext.ClientNodes.OrderByDescending(k=>k.Name);
    }

    async Task SaveRow(ClientNode item)
    {
        resetItemToIntert(item);
        if (grid != null)  await grid.UpdateRow(item);
    }

    async Task InsertRow()
    {
        itemToInsert = new ClientNode();
        if (grid != null) await grid.InsertRow(itemToInsert);
    }

    async Task EditRow(ClientNode item)
    {
        if (grid != null) await grid.EditRow(item);
    }

    void CancelEdit(ClientNode item)
    {
        resetItemToIntert(item);
        if (grid != null) grid.CancelEditRow(item);

        // For production
        var orderEntry = dbContext.Entry(item);
        if (orderEntry.State == EntityState.Modified)
        {
            orderEntry.CurrentValues.SetValues(orderEntry.OriginalValues);
            orderEntry.State = EntityState.Unchanged;
        }
    }

    async Task DeleteRow(ClientNode? item)
    {
        if (item == null) return;
        var dialogResult = await DialogService.Confirm("Ви впевнені?",
                                        "Видалення запису",
                                        new ConfirmOptions() { OkButtonText = "Так", CancelButtonText = "Ні" });
        if (dialogResult == true)
        {
            resetItemToIntert(item);
            if (items?.Contains(item) ?? false)
            {
                using (var transaction = await dbContext.Database.BeginTransactionAsync())
                {
                    string query = $"delete from QueryObjects where Sender={item.Id} or Destination={item.Id}"; 
                    await dbContext.Database.ExecuteSqlRawAsync(query);
                    query = $"delete from ObjectExchanges where Sender={item.Id} or Destination={item.Id}"; 
                    await dbContext.Database.ExecuteSqlRawAsync(query);
                    dbContext.Remove(item);
                    dbContext.SaveChanges();
                    
                }



                 if (grid != null) await grid.Reload();
            }
            else
            {
                if (grid != null) grid.CancelEditRow(item);
            }

        }
    }

    void OnCreateRow(ClientNode item)
    {
        item.Id = item.Name.ToLower();
        dbContext.Add(item);
        dbContext.SaveChanges();
    }
}
